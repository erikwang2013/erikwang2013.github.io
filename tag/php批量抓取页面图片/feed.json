{
    "version": "https://jsonfeed.org/version/1",
    "title": "艾瑞可erik • All posts by \"php批量抓取页面图片\" tag • All posts by \"undefined\" categories",
    "description": "一只PHP开发的程序猿，偶尔做做运维、Goland、Python、Java、摄影、画画、写作、顺便睡觉，反正整站都搞过。",
    "home_page_url": "https://erik.xyz",
    "items": [
        {
            "id": "https://erik.xyz/2019/09/03/zhua-qu-tu-pian-dao-ben-di-bing-sheng-cheng-sql/",
            "url": "https://erik.xyz/2019/09/03/zhua-qu-tu-pian-dao-ben-di-bing-sheng-cheng-sql/",
            "title": "抓取页面图到本地，并生成sql",
            "date_published": "2019-09-03T08:21:00.000Z",
            "content_html": "<p>闲来无事就做个图片抓取。<br>把某网站的图片抓取后，保存在本地指定目录，同时生成写入数据库的sql语句。</p>\n<p>思路如下：</p>\n<ol>\n<li>获取页面图的url</li>\n<li>根据图片url下载到本地</li>\n<li>把下载好的图片存储到指定目录，同时生成写入数据库的sql</li>\n</ol>\n<span id=\"more\"></span>\n<p>完整代码如下：</p>\n<pre><code>&lt;?php\n\n\nclass RetileImg\n&#123;\n\n    protected $url;   //请求地址\n\n    protected $url_status = false; // false是http请求 true是https请求\n\n    protected $img_path;  //图片存储地址\n\n    protected $sql_path;  //sql语句保存地址\n\n    protected $domain_name; //域名  如果有图片是相对路径就需要填写域名\n\n    public function __construct($url, $url_status, $img_path, $sql_path, $domain_name)\n    &#123;\n        $this-&gt;url = $url;\n        $this-&gt;url_status = $url_status;\n        $this-&gt;img_path = $img_path . &quot;/&quot; . date(&quot;Ymd&quot;) . &quot;/&quot;;\n        $this-&gt;sql_path = $sql_path . &quot;/&quot;;\n        $this-&gt;domain_name = $domain_name;\n    &#125;\n\n    /**获取页面\n     * @return bool|string\n     */\n    public function curl_web()\n    &#123;\n        $url = $this-&gt;url;\n        $url_status = $this-&gt;url_status;\n        $ch = curl_init($url);\n        curl_setopt($ch, CURLOPT_URL, $url);\n        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);\n        curl_setopt($ch, CURLOPT_TIMEOUT, 100);\n        curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 100);\n        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, $url_status);\n        $ch_content = curl_exec($ch);\n        return $ch_content;\n    &#125;\n\n    /**匹配页面的图片路径\n     * @param $content\n     * @return mixed|null\n     */\n    public function get_img_from_html($content)\n    &#123;\n        $pattern = &quot;/&lt;img.*?src=[\\&#39;|\\&quot;](.*?)[\\&#39;|\\&quot;].*?[\\/]?&gt;/&quot;;\n        $html_data = htmlspecialchars_decode($content);\n        preg_match_all($pattern, $html_data, $match);\n        if (!empty($match[1])) &#123;\n            return $match[1];\n        &#125;\n        return null;\n    &#125;\n\n    /**获取页面的所有图片路径\n     * @return mixed|null\n     */\n    public function get_img_urls()\n    &#123;\n        $url = $this-&gt;url;\n        $html_data = $this-&gt;curl_web($url);\n        $img_urls = $this-&gt;get_img_from_html($html_data) ?? null;\n        $domain_name = $this-&gt;domain_name;\n        $urls = [];\n        foreach ($img_urls as $k =&gt; $v) &#123;\n            if (empty($v)) &#123;\n                unset($k[$v]);\n            &#125;\n            $http_top = mb_substr($v, 0, 4);\n            if ($http_top != &#39;http&#39; &amp;&amp; !empty($domain_name)) &#123;\n                $v = $domain_name . $v;\n            &#125;;\n            $urls[] = $v;\n        &#125;\n        return $urls;\n    &#125;\n\n    /**下载图片到本地\n     * @throws Exception\n     */\n    public function download()\n    &#123;\n        $img_urls = $this-&gt;get_img_urls();\n        $img_path = $this-&gt;img_path;\n        $sql_path = $this-&gt;sql_path;\n        $mimes = array(\n            &#39;bmp&#39;,\n            &#39;gif&#39;,\n            &#39;jpg&#39;,\n            &#39;png&#39;,\n        );\n\n        $sql = &quot;insert into img_data (&#39;img_name&#39;,&#39;img_url&#39;,&#39;img_description&#39;,&#39;add_time&#39;) value (&quot;;\n        foreach ($img_urls as $k =&gt; $v) &#123;\n            $ext = mb_substr($v, -3);\n            // 如果符合我们要的类型\n            if (in_array($ext, $mimes)) &#123;\n                $number = random_int(10, 99999);\n                $img_name = date(&quot;YmdHis&quot;) . $number;\n                $content = file_get_contents($v);\n                if (!is_dir($img_path)) &#123;\n                    mkdir($img_path, 0777, true);\n                &#125;\n                //echo &quot;图片下载&quot; . $content . PHP_EOL;\n                $file_name = md5($img_name);\n                $file_path = $img_path . $file_name . &quot;.&quot; . $ext;\n                file_put_contents($file_path, $content);\n                $sql .= &quot;&#39;&quot; . $file_name . &quot;&#39;,&quot;;\n                $sql .= &quot;&#39;&quot; . $file_path . &quot;&#39;,&quot;;\n                $sql .= &quot;&#39;&quot; . $file_name . &quot;&#39;,&quot;;\n                $sql .= date(&quot;Y-m-d H:i:s&quot;);\n            &#125;\n        &#125;\n        $sql .= &quot;);&quot;;\n        if (!is_dir($sql_path)) &#123;\n            mkdir($sql_path, 0777, true);\n        &#125;\n        file_put_contents($sql_path . &quot;sql.txt&quot;, $sql);\n    &#125;\n&#125;\n\n\n//执行图片获取\nheader(&quot;Content-type: text/html; charset=utf-8&quot;);\n$img_data = new RetileImg(\n    &quot;https://erik.xyz/2014/10/17/zhe-shi-yi-ge-kai-shi-de-jie-shu/&quot;,\n    true,\n    &quot;./img&quot;,\n    &quot;./sql&quot;,\n    &quot;https://erik.xyz&quot;\n);\n$img_data-&gt;download();\n</code></pre>",
            "tags": [
                "php",
                "php抓取图片",
                "php批量抓取页面图片"
            ]
        }
    ]
}