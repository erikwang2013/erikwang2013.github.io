{
    "version": "https://jsonfeed.org/version/1",
    "title": "艾瑞可erik • All posts by \"蓝牙\" tag • All posts by \"undefined\" categories",
    "description": "一只PHP开发的程序猿，偶尔做做运维、Goland、Python、Java、摄影、画画、写作、顺便睡觉，反正整站都搞过。",
    "home_page_url": "https://erik.xyz",
    "items": [
        {
            "id": "https://erik.xyz/2025/08/25/luetoot-app/",
            "url": "https://erik.xyz/2025/08/25/luetoot-app/",
            "title": "『uni-app、小程序』蓝牙连接、读写数据全过程",
            "date_published": "2025-08-25T07:42:00.000Z",
            "content_html": "<ul>\n<li>开发工具：HBuilder X 3.4.7.20220422</li>\n<li>uni-app + Vue3</li>\n<li>以安卓App的方式运行（iOS和小程序同理）</li>\n</ul>\n<h3 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h3><p>蓝牙收发数据的逻辑和我们常用的 AJAX 进行的网络请求是有一丢丢不同的。<br>其中较大的区别是：蓝牙接收数据不是那么的稳定，相比起网络请求，蓝牙更容易出现丢包的情况。<br>在开发中，AJAX 发起的请求不管成功还是失败，浏览器基本都会给你一个答复。但 uni-app 提供的 api 来看，蓝牙接收数据会显得更加 “异步” 。<br><span id=\"more\"></span></p>\n<h4 id=\"大致思路\"><a href=\"#大致思路\" class=\"headerlink\" title=\"大致思路\"></a>大致思路</h4><p>使用蓝牙进行数据传输的大概思路如下：</p>\n<ol>\n<li>初始化：打开蓝牙模块</li>\n<li>搜寻：检测附近存在的设备</li>\n<li>连接：找到目标设备进行</li>\n<li>监听：开启监听功能，接收其他设备传过来的数据</li>\n<li>发送指令：不管发送数据还是读取数据，都可以理解为向外发送指令</li>\n</ol>\n<h4 id=\"初始化阶段\"><a href=\"#初始化阶段\" class=\"headerlink\" title=\"初始化阶段\"></a>初始化阶段</h4><p>使用蓝牙之前，需要初始化蓝牙模块，这是最最最开始就要做的！</p>\n<p>使用 uni.openBluetoothAdapter 这个 api 就可以初始化蓝牙模块。其他<br>蓝牙相关 API 必须在 uni.openBluetoothAdapter 调用之后使用。否则 API 会返回错误（ errCode=10000 ）。</p>\n<p>作者：德育处主任<br>链接：<a href=\"https://juejin.cn/post/7093171532318375950\">https://juejin.cn/post/7093171532318375950</a><br>来源：稀土掘金<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>\n<p>代码示例<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;template&gt;</span><br><span class=\"line\">    &lt;view&gt;</span><br><span class=\"line\">        &lt;button @click=&quot;initBlue&quot;&gt;初始化蓝牙&lt;/button&gt;</span><br><span class=\"line\">    &lt;/view&gt;</span><br><span class=\"line\">&lt;/template&gt;</span><br><span class=\"line\">​</span><br><span class=\"line\">&lt;script setup&gt;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【1】初始化蓝牙</span><br><span class=\"line\">function initBlue() &#123;</span><br><span class=\"line\">    uni.openBluetoothAdapter(&#123;</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(&#x27;初始化蓝牙成功&#x27;)</span><br><span class=\"line\">            console.log(res)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.log(&#x27;初始化蓝牙失败&#x27;)</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\n<p>如果你手机开启了蓝牙，点击页面上的按钮后，控制台就会输出如下内容<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&quot;errMsg&quot;:&quot;openBluetoothAdapter:ok&quot;&#125;</span><br></pre></td></tr></table></figure></p>\n<p>如果手机没开启蓝牙，就会返回如下内容</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&quot;errMsg&quot;:&quot;openBluetoothAdapter:fail not available&quot;,&quot;code&quot;:10001&#125;</span><br></pre></td></tr></table></figure>\n<p>10001代表当前蓝牙适配器不可用。</p>\n<p>如果你的控制台能打印出 {“errMsg”:”openBluetoothAdapter:ok”} 证明第一步已经成功了。</p>\n<p>接下来可以开始搜索附近蓝牙设备。</p>\n<h4 id=\"搜寻附近设备\"><a href=\"#搜寻附近设备\" class=\"headerlink\" title=\"搜寻附近设备\"></a>搜寻附近设备</h4><p>这一步需要2个 api 配合完成。所以可以分解成以下2步：</p>\n<ul>\n<li>开启搜寻功能：uni.startBluetoothDevicesDiscovery</li>\n<li>监听搜寻到新设备：uni.onBluetoothDeviceFound</li>\n</ul>\n<p>开发蓝牙相关功能时，操作逻辑更像是推送，所以“开启搜索”和“监听新设备”是分开操作的。</p>\n<p>uni.startBluetoothDevicesDiscovery 可以让设备开始搜索附近蓝牙设备，但这个方法比较耗费系统资源，建议在连接到设备之后就使用 uni.stopBluetoothDevicesDiscovery 停止继续搜索。</p>\n<p>uni.startBluetoothDevicesDiscovery 方法里可以传入一个对象，该对象接收几个参数，但初学的话我们只关注 success 和 fail。如果你的项目中硬件佬有提供 service 的 uuid 给你的话，你也可以在 services 里传入。其他参数可以查看官方文档的介绍。</p>\n<p>在使用 uni.startBluetoothDevicesDiscovery （开始搜索）后，可以使用 uni.onBluetoothDeviceFound 进行监听，这个方法里面接收一个回调函数。</p>\n<p>代码示例<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;template&gt;</span><br><span class=\"line\">    &lt;view&gt;</span><br><span class=\"line\">        &lt;scroll-view</span><br><span class=\"line\">            scroll-y</span><br><span class=\"line\">            class=&quot;box&quot;</span><br><span class=\"line\">        &gt;</span><br><span class=\"line\">            &lt;view class=&quot;item&quot; v-for=&quot;item in blueDeviceList&quot;&gt;</span><br><span class=\"line\">                &lt;view&gt;</span><br><span class=\"line\">                    &lt;text&gt;id: &#123;&#123; item.deviceId &#125;&#125;&lt;/text&gt;    </span><br><span class=\"line\">                &lt;/view&gt;</span><br><span class=\"line\">                &lt;view&gt;</span><br><span class=\"line\">                    &lt;text&gt;name: &#123;&#123; item.name &#125;&#125;&lt;/text&gt;  </span><br><span class=\"line\">                &lt;/view&gt;</span><br><span class=\"line\">            &lt;/view&gt;</span><br><span class=\"line\">        &lt;/scroll-view&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">        &lt;button @click=&quot;initBlue&quot;&gt;初始化蓝牙&lt;/button&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">        &lt;button @click=&quot;discovery&quot;&gt;搜索附近蓝牙设备&lt;/button&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;/view&gt;</span><br><span class=\"line\">&lt;/template&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script setup&gt;</span><br><span class=\"line\">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">// 搜索到的蓝牙设备列表</span><br><span class=\"line\">const blueDeviceList = ref([])</span><br><span class=\"line\"></span><br><span class=\"line\">// 【1】初始化蓝牙</span><br><span class=\"line\">function initBlue() &#123;</span><br><span class=\"line\">    uni.openBluetoothAdapter(&#123;</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(&#x27;初始化蓝牙成功&#x27;)</span><br><span class=\"line\">            console.log(res)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.log(&#x27;初始化蓝牙失败&#x27;)</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// 【2】开始搜寻附近设备</span><br><span class=\"line\">function discovery() &#123;</span><br><span class=\"line\">    uni.startBluetoothDevicesDiscovery(&#123;</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(&#x27;开始搜索&#x27;)</span><br><span class=\"line\">            </span><br><span class=\"line\">            // 开启监听回调</span><br><span class=\"line\">            uni.onBluetoothDeviceFound(found)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.log(&#x27;搜索失败&#x27;)</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// 【3】找到新设备就触发该方法</span><br><span class=\"line\">function found(res) &#123;</span><br><span class=\"line\">    console.log(res)</span><br><span class=\"line\">    blueDeviceList.value.push(res.devices[0])</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;style&gt;</span><br><span class=\"line\">.box &#123;</span><br><span class=\"line\">    width: 100%;</span><br><span class=\"line\">    height: 400rpx;</span><br><span class=\"line\">    box-sizing: border-box;</span><br><span class=\"line\">    margin-bottom: 20rpx;</span><br><span class=\"line\">    border: 2px solid dodgerblue;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">.item &#123;</span><br><span class=\"line\">    box-sizing: border-box;</span><br><span class=\"line\">    padding: 10rpx;</span><br><span class=\"line\">    border-bottom: 1px solid #ccc;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">button &#123;</span><br><span class=\"line\">    margin-bottom: 20rpx;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/style&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\n<p>上面代码的逻辑是，如果开启 “寻找附近设备” 功能成功，接着就开启 “监听寻找到新设备的事件” 。</p>\n<p>搜索到的设备会返回以下数据：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;devices&quot;: [&#123;</span><br><span class=\"line\">        &quot;deviceId&quot;: &quot;B4:10:7B:C4:83:14&quot;,</span><br><span class=\"line\">        &quot;name&quot;: &quot;蓝牙设备名&quot;,</span><br><span class=\"line\">        &quot;RSSI&quot;: -58,</span><br><span class=\"line\">        &quot;localName&quot;: &quot;&quot;,</span><br><span class=\"line\">        &quot;advertisServiceUUIDs&quot;: [&quot;0000FFF0-0000-1000-8000-00805F9B34FB&quot;],</span><br><span class=\"line\">        &quot;advertisData&quot;: &#123;&#125;</span><br><span class=\"line\">    &#125;]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>每监听到一个新的设备，我都会将其添加到 蓝牙设备列表(blueDeviceList) 里，最后讲这个列表的数据渲染到页面上。</p>\n<h4 id=\"连接目标设备\"><a href=\"#连接目标设备\" class=\"headerlink\" title=\"连接目标设备\"></a>连接目标设备</h4><p>连接目标设备只需要1个 api 就能完成。但根据文档提示，我们连接后还需要关闭 “搜索附近设备” 的功能，这个很好理解，既然找到了，再继续找就是浪费资源。</p>\n<p>流程如下：</p>\n<ul>\n<li>获取设备ID：根据 uni.onBluetoothDeviceFound 回调，拿到设备ID</li>\n<li>连接设备：使用设备ID进行连接 uni.createBLEConnection</li>\n<li>停止搜索：uni.stopBluetoothDevicesDiscovery</li>\n</ul>\n<p>我给每条搜索到的蓝牙结果添加一个 click 事件，会向目标设备发送连接请求。<br>我的设备名称是 leihou ，所以我点击了这条。</p>\n<p>代码示例<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;template&gt;</span><br><span class=\"line\">    &lt;view&gt;</span><br><span class=\"line\">        &lt;scroll-view</span><br><span class=\"line\">            scroll-y</span><br><span class=\"line\">            class=&quot;box&quot;</span><br><span class=\"line\">        &gt;</span><br><span class=\"line\">            &lt;view class=&quot;item&quot; v-for=&quot;item in blueDeviceList&quot; @click=&quot;connect(item)&quot;&gt;</span><br><span class=\"line\">                &lt;view&gt;</span><br><span class=\"line\">                    &lt;text&gt;id: &#123;&#123; item.deviceId &#125;&#125;&lt;/text&gt;    </span><br><span class=\"line\">                &lt;/view&gt;</span><br><span class=\"line\">                &lt;view&gt;</span><br><span class=\"line\">                    &lt;text&gt;name: &#123;&#123; item.name &#125;&#125;&lt;/text&gt;  </span><br><span class=\"line\">                &lt;/view&gt;</span><br><span class=\"line\">            &lt;/view&gt;</span><br><span class=\"line\">        &lt;/scroll-view&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">        &lt;button @click=&quot;initBlue&quot;&gt;初始化蓝牙&lt;/button&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">        &lt;button @click=&quot;discovery&quot;&gt;搜索附近蓝牙设备&lt;/button&gt;</span><br><span class=\"line\">​</span><br><span class=\"line\">    &lt;/view&gt;</span><br><span class=\"line\">&lt;/template&gt;</span><br><span class=\"line\">​</span><br><span class=\"line\">&lt;script setup&gt;</span><br><span class=\"line\">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 搜索到的蓝牙设备列表</span><br><span class=\"line\">const blueDeviceList = ref([])</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【1】初始化蓝牙</span><br><span class=\"line\">function initBlue() &#123;</span><br><span class=\"line\">    uni.openBluetoothAdapter(&#123;</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(&#x27;初始化蓝牙成功&#x27;)</span><br><span class=\"line\">            console.log(res)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.log(&#x27;初始化蓝牙失败&#x27;)</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【2】开始搜寻附近设备</span><br><span class=\"line\">function discovery() &#123;</span><br><span class=\"line\">    uni.startBluetoothDevicesDiscovery(&#123;</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(&#x27;开始搜索&#x27;)</span><br><span class=\"line\">            // 开启监听回调</span><br><span class=\"line\">            uni.onBluetoothDeviceFound(found)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.log(&#x27;搜索失败&#x27;)</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【3】找到新设备就触发该方法</span><br><span class=\"line\">function found(res) &#123;</span><br><span class=\"line\">    console.log(res)</span><br><span class=\"line\">    blueDeviceList.value.push(res.devices[0])</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 蓝牙设备的id</span><br><span class=\"line\">const deviceId = ref(&#x27;&#x27;)</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【4】连接设备</span><br><span class=\"line\">function connect(data) &#123;</span><br><span class=\"line\">    console.log(data)</span><br><span class=\"line\">​</span><br><span class=\"line\">    deviceId.value = data.deviceId</span><br><span class=\"line\">​</span><br><span class=\"line\">    uni.createBLEConnection(&#123;</span><br><span class=\"line\">        deviceId: deviceId.value,</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(&#x27;连接成功&#x27;)</span><br><span class=\"line\">            console.log(res)</span><br><span class=\"line\">            // 停止搜索</span><br><span class=\"line\">            stopDiscovery()</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.log(&#x27;连接失败&#x27;)</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【5】停止搜索</span><br><span class=\"line\">function stopDiscovery() &#123;</span><br><span class=\"line\">    uni.stopBluetoothDevicesDiscovery(&#123;</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(&#x27;停止成功&#x27;)</span><br><span class=\"line\">            console.log(res)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.log(&#x27;停止失败&#x27;)</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">​</span><br><span class=\"line\">&lt;style&gt;</span><br><span class=\"line\">.box &#123;</span><br><span class=\"line\">    width: 100%;</span><br><span class=\"line\">    height: 400rpx;</span><br><span class=\"line\">    box-sizing: border-box;</span><br><span class=\"line\">    margin-bottom: 20rpx;</span><br><span class=\"line\">    border: 2px solid dodgerblue;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">.item &#123;</span><br><span class=\"line\">    box-sizing: border-box;</span><br><span class=\"line\">    padding: 10rpx;</span><br><span class=\"line\">    border-bottom: 1px solid #ccc;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">button &#123;</span><br><span class=\"line\">    margin-bottom: 20rpx;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/style&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\n<p>连接成功后在控制台会输出<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&quot;errMsg&quot;:&quot;createBLEConnection:ok&quot;&#125;</span><br></pre></td></tr></table></figure></p>\n<p>在连接成功后就立刻调用 uni.stopBluetoothDevicesDiscovery 方法停止继续搜索附近其他设备，停止成功后会输出</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&quot;errMsg&quot;:&quot;stopBluetoothDevicesDiscovery:ok&quot;&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"监听\"><a href=\"#监听\" class=\"headerlink\" title=\"监听\"></a>监听</h4><p>在连接完设备后，就要先开启监听数据的功能。这样才能接收到发送读写指令后设备给你回调的信息。</p>\n<p>要开启监听，首先需要知道蓝牙设备提供了那些服务，然后通过服务获取特征值，特征值会告诉你哪个可读，哪个可写。最后根据特征值进行消息监听。</p>\n<p>步骤如下：</p>\n<ul>\n<li>获取蓝牙设备服务：uni.getBLEDeviceServices</li>\n<li>获取特征值：uni.getBLEDeviceCharacteristics</li>\n<li>开启消息监听：uni.notifyBLECharacteristicValueChange</li>\n<li>接收消息监听传来的数据：uni.onBLECharacteristicValueChange</li>\n</ul>\n<p>正常情况下，硬件佬会提前把蓝牙设备的指定服务还有特征值告诉你。</p>\n<p>比如我这个设备的蓝牙服务是：0000FFE0-0000-1000-8000-00805F9B34FB</p>\n<p>特征值是：0000FFE1-0000-1000-8000-00805F9B34FB</p>\n<h5 id=\"第一步，获取蓝牙服务\"><a href=\"#第一步，获取蓝牙服务\" class=\"headerlink\" title=\"第一步，获取蓝牙服务\"></a>第一步，获取蓝牙服务</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;template&gt;</span><br><span class=\"line\">    &lt;view&gt;</span><br><span class=\"line\">        &lt;!-- 省略上一步的代码 --&gt;</span><br><span class=\"line\">        &lt;button @click=&quot;getServices&quot;&gt;获取蓝牙服务&lt;/button&gt;</span><br><span class=\"line\">    &lt;/view&gt;</span><br><span class=\"line\">&lt;/template&gt;</span><br><span class=\"line\">​</span><br><span class=\"line\">&lt;script setup&gt;</span><br><span class=\"line\">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 省略上一步的代码……</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【6】获取服务</span><br><span class=\"line\">function getServices() &#123;</span><br><span class=\"line\">    uni.getBLEDeviceServices(&#123;</span><br><span class=\"line\">        deviceId: deviceId.value, // 设备ID，在上一步【4】里获取</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(res)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>此时点击按钮，将会获取到已连接设备的所有服务。</p>\n<p>我的设备有以下几个服务。你在工作中拿到的 服务uuid 和我的是不一样的，数量也不一定相同。</p>\n<p>可以发现，我拿到的结果里有 0000FFE0-0000-1000-8000-00805F9B34FB 这条服务。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;services&quot;: [&#123;</span><br><span class=\"line\">        &quot;uuid&quot;: &quot;00001800-0000-1000-8000-00805F9B34FB&quot;,</span><br><span class=\"line\">        &quot;isPrimary&quot;: true</span><br><span class=\"line\">    &#125;, &#123;</span><br><span class=\"line\">        &quot;uuid&quot;: &quot;00001801-0000-1000-8000-00805F9B34FB&quot;,</span><br><span class=\"line\">        &quot;isPrimary&quot;: true</span><br><span class=\"line\">    &#125;, &#123;</span><br><span class=\"line\">        &quot;uuid&quot;: &quot;0000180A-0000-1000-8000-00805F9B34FB&quot;,</span><br><span class=\"line\">        &quot;isPrimary&quot;: true</span><br><span class=\"line\">    &#125;, &#123;</span><br><span class=\"line\">        &quot;uuid&quot;: &quot;0000FFF0-0000-1000-8000-00805F9B34FB&quot;,</span><br><span class=\"line\">        &quot;isPrimary&quot;: true</span><br><span class=\"line\">    &#125;, &#123;</span><br><span class=\"line\">        &quot;uuid&quot;: &quot;0000FFE0-0000-1000-8000-00805F9B34FB&quot;,</span><br><span class=\"line\">        &quot;isPrimary&quot;: true</span><br><span class=\"line\">    &#125;],</span><br><span class=\"line\">    &quot;errMsg&quot;: &quot;getBLEDeviceServices:ok&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h5 id=\"第二步，获取指定服务的特征值\"><a href=\"#第二步，获取指定服务的特征值\" class=\"headerlink\" title=\"第二步，获取指定服务的特征值\"></a>第二步，获取指定服务的特征值</h5><p>获取特征值，需要传 设备ID 和 服务ID。</p>\n<p>在上两步我拿到了 设备ID 为 B4:10:7B:C4:83:14，服务ID 为 0000FFE0-0000-1000-8000-00805F9B34FB。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;template&gt;</span><br><span class=\"line\">    &lt;view&gt;</span><br><span class=\"line\">        &lt;!-- 省略前面几步代码 --&gt;</span><br><span class=\"line\">        &lt;button @click=&quot;getCharacteristics&quot;&gt;获取特征值&lt;/button&gt;</span><br><span class=\"line\">    &lt;/view&gt;</span><br><span class=\"line\">&lt;/template&gt;</span><br><span class=\"line\">​</span><br><span class=\"line\">&lt;script setup&gt;</span><br><span class=\"line\">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 省略前面几步代码</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【7】获取特征值</span><br><span class=\"line\">function getCharacteristics() &#123;</span><br><span class=\"line\">    uni.getBLEDeviceCharacteristics(&#123;</span><br><span class=\"line\">        deviceId: deviceId.value, // 设备ID，在【4】里获取到</span><br><span class=\"line\">        serviceId: &#x27;0000FFE0-0000-1000-8000-00805F9B34FB&#x27;, // 服务UUID，在【6】里能获取到</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(res)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>最后成功输出</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;characteristics&quot;: [&#123;</span><br><span class=\"line\">        &quot;uuid&quot;: &quot;0000FFE1-0000-1000-8000-00805F9B34FB&quot;,</span><br><span class=\"line\">        &quot;properties&quot;: &#123;</span><br><span class=\"line\">            &quot;read&quot;: true,</span><br><span class=\"line\">            &quot;write&quot;: true,</span><br><span class=\"line\">            &quot;notify&quot;: true,</span><br><span class=\"line\">            &quot;indicate&quot;: false</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;],</span><br><span class=\"line\">    &quot;errMsg&quot;: &quot;getBLEDeviceCharacteristics:ok&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>characteristics 字段里保存了该服务的所有特征值，我的设备这个服务只有1个特征值，并且读、写、消息推送都为 true。</p>\n<p>你的设备可能不止一条特征值，需要监听那条特征值这需要你和硬件佬协商的（通常也是硬件佬直接和你说要监听哪条）。</p>\n<h5 id=\"第三、四步，开启消息监听-并-接收消息监听传来的数据\"><a href=\"#第三、四步，开启消息监听-并-接收消息监听传来的数据\" class=\"headerlink\" title=\"第三、四步，开启消息监听 并 接收消息监听传来的数据\"></a>第三、四步，开启消息监听 并 接收消息监听传来的数据</h5><p>根据已经拿到的 设备ID、服务ID、特征值，就可以开启对应的监听功能。</p>\n<p>使用 uni.notifyBLECharacteristicValueChange 开启消息监听；</p>\n<p>并在 uni.onBLECharacteristicValueChange 方法触发监听到的消息。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;template&gt;</span><br><span class=\"line\">    &lt;view&gt;</span><br><span class=\"line\">        &lt;!-- 省略前面几步代码 --&gt;</span><br><span class=\"line\">        &lt;button @click=&quot;notify&quot;&gt;开启消息监听&lt;/button&gt;</span><br><span class=\"line\">    &lt;/view&gt;</span><br><span class=\"line\">&lt;/template&gt;</span><br><span class=\"line\">​</span><br><span class=\"line\">&lt;script setup&gt;</span><br><span class=\"line\">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 省略前面几步代码</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【8】开启消息监听</span><br><span class=\"line\">function notify() &#123;</span><br><span class=\"line\">    uni.notifyBLECharacteristicValueChange(&#123;</span><br><span class=\"line\">        deviceId: deviceId.value, // 设备ID，在【4】里获取到</span><br><span class=\"line\">        serviceId: &#x27;0000FFE0-0000-1000-8000-00805F9B34FB&#x27;, // 服务UUID，在【6】里能获取到</span><br><span class=\"line\">        characteristicId: &#x27;0000FFE1-0000-1000-8000-00805F9B34FB&#x27;, // 特征值，在【7】里能获取到</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(res)</span><br><span class=\"line\">            </span><br><span class=\"line\">            // 接受消息的方法</span><br><span class=\"line\">            listenValueChange()</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// ArrayBuffer转16进度字符串示例</span><br><span class=\"line\">function ab2hex(buffer) &#123;</span><br><span class=\"line\">  const hexArr = Array.prototype.map.call(</span><br><span class=\"line\">    new Uint8Array(buffer),</span><br><span class=\"line\">    function (bit) &#123;</span><br><span class=\"line\">      return (&#x27;00&#x27; + bit.toString(16)).slice(-2)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  )</span><br><span class=\"line\">  return hexArr.join(&#x27;&#x27;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 将16进制的内容转成我们看得懂的字符串内容</span><br><span class=\"line\">function hexCharCodeToStr(hexCharCodeStr) &#123;</span><br><span class=\"line\">    var trimedStr = hexCharCodeStr.trim();</span><br><span class=\"line\">    var rawStr = trimedStr.substr(0, 2).toLowerCase() === &quot;0x&quot; ? trimedStr.substr(2) : trimedStr;</span><br><span class=\"line\">    var len = rawStr.length;</span><br><span class=\"line\">    if (len % 2 !== 0) &#123;</span><br><span class=\"line\">            alert(&quot;存在非法字符!&quot;);</span><br><span class=\"line\">            return &quot;&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    var curCharCode;</span><br><span class=\"line\">    var resultStr = [];</span><br><span class=\"line\">    for (var i = 0; i &lt; len; i = i + 2) &#123;</span><br><span class=\"line\">            curCharCode = parseInt(rawStr.substr(i, 2), 16);</span><br><span class=\"line\">            resultStr.push(String.fromCharCode(curCharCode));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return resultStr.join(&quot;&quot;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【9】监听消息变化</span><br><span class=\"line\">function listenValueChange() &#123;</span><br><span class=\"line\">    uni.onBLECharacteristicValueChange(res =&gt; &#123;</span><br><span class=\"line\">        // 结果</span><br><span class=\"line\">        console.log(res)</span><br><span class=\"line\">        </span><br><span class=\"line\">        // 结果里有个value值，该值为 ArrayBuffer 类型，所以在控制台无法用肉眼观察到，必须将该值转换为16进制</span><br><span class=\"line\">        let resHex = ab2hex(res.value)</span><br><span class=\"line\">        console.log(resHex)</span><br><span class=\"line\">​</span><br><span class=\"line\">        // 最后将16进制转换为ascii码，就能看到对应的结果</span><br><span class=\"line\">        let result = hexCharCodeToStr(resHex)</span><br><span class=\"line\">        console.log(result)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>listenValueChange 方法是用来接收设备传过来的消息。</p>\n<p>上面的例子中，res 的结果是</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;deviceId&quot;: &quot;B4:10:7B:C4:83:14&quot;,</span><br><span class=\"line\">    &quot;serviceId&quot;: &quot;0000FFE0-0000-1000-8000-00805F9B34FB&quot;,</span><br><span class=\"line\">    &quot;characteristicId&quot;: &quot;0000FFE1-0000-1000-8000-00805F9B34FB&quot;,</span><br><span class=\"line\">    &quot;value&quot;: &#123;&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>设备传过来的内容就放在 value 字段里，但因为该字段的类型是 ArrayBuffer，所以无法在控制台用肉眼直接观察。于是就通过 ab2hex 方法将该值转成 16进制 ，最后再用 hexCharCodeToStr 方法将 16进制 转成 ASCII码。</p>\n<p>我从设备里发送一段字符串过来：leihou</p>\n<p>App端收到的数据转成 16进制 后的结果：6c6569686f75</p>\n<p>再从 16进制 转成 ASCII码 后的结果：leihou</p>\n<h4 id=\"发送指令\"><a href=\"#发送指令\" class=\"headerlink\" title=\"发送指令\"></a>发送指令</h4><p>终于到最后一步了。</p>\n<p>从 uni-app 和 微信小程序 提供的蓝牙api 来看，发送指令只要有2个方法：</p>\n<ul>\n<li>uni.writeBLECharacteristicValue：向低功耗蓝牙设备特征值中写入二进制数据。</li>\n<li>uni.readBLECharacteristicValue：读取低功耗蓝牙设备的特征值的二进制数据值。</li>\n</ul>\n<p>这里需要理清一个概念，本节的内容为 “发送指令” ，也就是说，从你的app或小程序向其他蓝牙设备发送指令，而这个指令分2种情况，一种是你要发送一些数据给蓝牙设备，另一种情况是你叫蓝牙设备给你发点信息。</p>\n<p>uni.writeBLECharacteristicValue</p>\n<p>这两种情况我们需要分开讨论，先讲uni.writeBLECharacteristicValue 。</p>\n<p>uni.writeBLECharacteristicValue 从文档可以看出，这个 api 是可以发送一些数据给蓝牙设备，但发送的值要转成 ArrayBuffer 。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;template&gt;</span><br><span class=\"line\">    &lt;view&gt;</span><br><span class=\"line\">        &lt;!-- 省略前面几步代码 --&gt;</span><br><span class=\"line\">        &lt;button @click=&quot;send&quot;&gt;发送数据&lt;/button&gt;</span><br><span class=\"line\">    &lt;/view&gt;</span><br><span class=\"line\">&lt;/template&gt;</span><br><span class=\"line\">​</span><br><span class=\"line\">&lt;script setup&gt;</span><br><span class=\"line\">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 省略前面几步代码</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【10】发送数据</span><br><span class=\"line\">function send() &#123;</span><br><span class=\"line\">    // 向蓝牙设备发送一个0x00的16进制数据</span><br><span class=\"line\">    </span><br><span class=\"line\">    let msg = &#x27;hello&#x27;</span><br><span class=\"line\">    </span><br><span class=\"line\">    const buffer = new ArrayBuffer(msg.length)</span><br><span class=\"line\">    const dataView = new DataView(buffer)</span><br><span class=\"line\">    // dataView.setUint8(0, 0)</span><br><span class=\"line\">    </span><br><span class=\"line\">    for (var i = 0; i &lt; msg.length; i++) &#123;</span><br><span class=\"line\">      dataView.setUint8(i, msg.charAt(i).charCodeAt())</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    uni.writeBLECharacteristicValue(&#123;</span><br><span class=\"line\">      deviceId: deviceId.value, // 设备ID，在【4】里获取到</span><br><span class=\"line\">      serviceId: &#x27;0000FFE0-0000-1000-8000-00805F9B34FB&#x27;, // 服务UUID，在【6】里能获取到</span><br><span class=\"line\">      characteristicId: &#x27;0000FFE1-0000-1000-8000-00805F9B34FB&#x27;, // 特征值，在【7】里能获取到</span><br><span class=\"line\">      value: buffer,</span><br><span class=\"line\">      success(res) &#123;</span><br><span class=\"line\">        console.log(res)</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      fail(err) &#123;</span><br><span class=\"line\">        console.error(err)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>此时，如果 uni.writeBLECharacteristicValue 走 success ，证明你已经把数据向外成功发送了，但不代表设备一定就收到了。</p>\n<p>通常设备收到你发送过去的信息，会返回一条消息给你，而这个回调消息会在 uni.onBLECharacteristicValueChange 触发，也就是 第【9】步 那里。但这是蓝牙设备那边控制的，你作为前端佬，人家“已读不回”你也拿人家没办法。</p>\n<p>uni.readBLECharacteristicValue</p>\n<p>在 “监听” 部分，我们使用了 uni.getBLEDeviceCharacteristics 获取设备的特征值，我的设备提供的特征值支持 read ，所以可以使用 uni.readBLECharacteristicValue 向蓝牙设备发送一条 “读取” 指令。然后在 uni.onBLECharacteristicValueChange 里可以接收设备发送过来的数据。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;template&gt;</span><br><span class=\"line\">    &lt;view&gt;</span><br><span class=\"line\">        &lt;!-- 省略前面几步代码 --&gt;</span><br><span class=\"line\">        &lt;button @click=&quot;read&quot;&gt;读取数据&lt;/button&gt;</span><br><span class=\"line\">    &lt;/view&gt;</span><br><span class=\"line\">&lt;/template&gt;</span><br><span class=\"line\">​</span><br><span class=\"line\">&lt;script setup&gt;</span><br><span class=\"line\">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 省略前面几步代码</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【11】读取数据</span><br><span class=\"line\">function read() &#123;</span><br><span class=\"line\">    uni.readBLECharacteristicValue(&#123;</span><br><span class=\"line\">        deviceId: deviceId.value,</span><br><span class=\"line\">        serviceId: serviceId.value,</span><br><span class=\"line\">        characteristicId: characteristicId.value,</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(&#x27;读取指令发送成功&#x27;)</span><br><span class=\"line\">            console.log(res)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.log(&#x27;读取指令发送失败&#x27;)</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>使用 “读取” 的方式向设备发送指令，是不需要另外传值的。</p>\n<p>此时我的设备返回 00</p>\n<p>这个数据是硬件那边设置的。</p>\n<p>在日常工作中，uni.readBLECharacteristicValue 的作用主要是读取数据，但使用场景不算很多。</p>\n<p>我在工作中遇到的场景是：蓝牙设备提供了几个接口，而且传过来的数据比较大，比如传图片给app这边。我就会先用 uni.writeBLECharacteristicValue 告诉设备我现在需要取什么接口的数据，然后用 uni.readBLECharacteristicValue 发送读取数据的请求，如果数据量比较大，就要重复使用 uni.readBLECharacteristicValue 进行读取。比如上面的例子，我读第一次的时候返回 00 ，读第二次就返回 01 ……</p>\n<p>最后再提醒一下，uni.readBLECharacteristicValue 只负责发送读取的请求，并且里面的 success 和 fail 只是返回你本次发送请求的动作是否成功，至于对面的蓝牙设备有没有收到这个指令你是不清楚的。</p>\n<p>最后需要通过 uni.getBLEDeviceCharacteristics 监听设备传过来的数据。</p>\n<p>完整代码<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;template&gt;</span><br><span class=\"line\">    &lt;view&gt;</span><br><span class=\"line\">        &lt;scroll-view</span><br><span class=\"line\">            scroll-y</span><br><span class=\"line\">            class=&quot;box&quot;</span><br><span class=\"line\">        &gt;</span><br><span class=\"line\">            &lt;view class=&quot;item&quot; v-for=&quot;item in blueDeviceList&quot; @click=&quot;connect(item)&quot;&gt;</span><br><span class=\"line\">                &lt;view&gt;</span><br><span class=\"line\">                    &lt;text&gt;id: &#123;&#123; item.deviceId &#125;&#125;&lt;/text&gt;    </span><br><span class=\"line\">                &lt;/view&gt;</span><br><span class=\"line\">                &lt;view&gt;</span><br><span class=\"line\">                    &lt;text&gt;name: &#123;&#123; item.name &#125;&#125;&lt;/text&gt;  </span><br><span class=\"line\">                &lt;/view&gt;</span><br><span class=\"line\">            &lt;/view&gt;</span><br><span class=\"line\">        &lt;/scroll-view&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">        &lt;button @click=&quot;initBlue&quot;&gt;1 初始化蓝牙&lt;/button&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">        &lt;button @click=&quot;discovery&quot;&gt;2 搜索附近蓝牙设备&lt;/button&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">        &lt;button @click=&quot;getServices&quot;&gt;3 获取蓝牙服务&lt;/button&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">        &lt;button @click=&quot;getCharacteristics&quot;&gt;4 获取特征值&lt;/button&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">        &lt;button @click=&quot;notify&quot;&gt;5 开启消息监听&lt;/button&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">        &lt;button @click=&quot;send&quot;&gt;6 发送数据&lt;/button&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">        &lt;button @click=&quot;read&quot;&gt;7 读取数据&lt;/button&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">        &lt;view class=&quot;msg_x&quot;&gt;</span><br><span class=\"line\">            &lt;view class=&quot;msg_txt&quot;&gt;</span><br><span class=\"line\">                监听到的内容：&#123;&#123; message &#125;&#125;</span><br><span class=\"line\">            &lt;/view&gt;</span><br><span class=\"line\">            &lt;view class=&quot;msg_hex&quot;&gt;</span><br><span class=\"line\">                监听到的内容（十六进制）：&#123;&#123; messageHex &#125;&#125;</span><br><span class=\"line\">            &lt;/view&gt; </span><br><span class=\"line\">        &lt;/view&gt; </span><br><span class=\"line\">​</span><br><span class=\"line\">    &lt;/view&gt;</span><br><span class=\"line\">&lt;/template&gt;</span><br><span class=\"line\">​</span><br><span class=\"line\">&lt;script setup&gt;</span><br><span class=\"line\">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 搜索到的蓝牙设备列表</span><br><span class=\"line\">const blueDeviceList = ref([])</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【1】初始化蓝牙</span><br><span class=\"line\">function initBlue() &#123;</span><br><span class=\"line\">    uni.openBluetoothAdapter(&#123;</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(&#x27;初始化蓝牙成功&#x27;)</span><br><span class=\"line\">            console.log(res)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.log(&#x27;初始化蓝牙失败&#x27;)</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【2】开始搜寻附近设备</span><br><span class=\"line\">function discovery() &#123;</span><br><span class=\"line\">    uni.startBluetoothDevicesDiscovery(&#123;</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(&#x27;开始搜索&#x27;)</span><br><span class=\"line\">            // 开启监听回调</span><br><span class=\"line\">            uni.onBluetoothDeviceFound(found)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.log(&#x27;搜索失败&#x27;)</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【3】找到新设备就触发该方法</span><br><span class=\"line\">function found(res) &#123;</span><br><span class=\"line\">    console.log(res)</span><br><span class=\"line\">    blueDeviceList.value.push(res.devices[0])</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 蓝牙设备的id</span><br><span class=\"line\">const deviceId = ref(&#x27;&#x27;)</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【4】连接设备</span><br><span class=\"line\">function connect(data) &#123;</span><br><span class=\"line\">    console.log(data)</span><br><span class=\"line\">    </span><br><span class=\"line\">    deviceId.value = data.deviceId // 将获取到的设备ID存起来</span><br><span class=\"line\">    </span><br><span class=\"line\">    uni.createBLEConnection(&#123;</span><br><span class=\"line\">        deviceId: deviceId.value,</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(&#x27;连接成功&#x27;)</span><br><span class=\"line\">            console.log(res)</span><br><span class=\"line\">            // 停止搜索</span><br><span class=\"line\">            stopDiscovery()</span><br><span class=\"line\">            uni.showToast(&#123;</span><br><span class=\"line\">                title: &#x27;连接成功&#x27;</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.log(&#x27;连接失败&#x27;)</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">            uni.showToast(&#123;</span><br><span class=\"line\">                title: &#x27;连接成功&#x27;,</span><br><span class=\"line\">                icon: &#x27;error&#x27;</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【5】停止搜索</span><br><span class=\"line\">function stopDiscovery() &#123;</span><br><span class=\"line\">    uni.stopBluetoothDevicesDiscovery(&#123;</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(&#x27;停止成功&#x27;)</span><br><span class=\"line\">            console.log(res)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.log(&#x27;停止失败&#x27;)</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【6】获取服务</span><br><span class=\"line\">function getServices() &#123;</span><br><span class=\"line\">    // 如果是自动链接的话，uni.getBLEDeviceServices方法建议使用setTimeout延迟1秒后再执行</span><br><span class=\"line\">    uni.getBLEDeviceServices(&#123;</span><br><span class=\"line\">        deviceId: deviceId.value,</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(res) // 可以在res里判断有没有硬件佬给你的服务</span><br><span class=\"line\">            uni.showToast(&#123;</span><br><span class=\"line\">                title: &#x27;获取服务成功&#x27;</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">            uni.showToast(&#123;</span><br><span class=\"line\">                title: &#x27;获取服务失败&#x27;,</span><br><span class=\"line\">                icon: &#x27;error&#x27;</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 硬件提供的服务id，开发中需要问硬件佬获取该id</span><br><span class=\"line\">const serviceId = ref(&#x27;0000FFE0-0000-1000-8000-00805F9B34FB&#x27;)</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【7】获取特征值</span><br><span class=\"line\">function getCharacteristics() &#123;</span><br><span class=\"line\">    // 如果是自动链接的话，uni.getBLEDeviceCharacteristics方法建议使用setTimeout延迟1秒后再执行</span><br><span class=\"line\">    uni.getBLEDeviceCharacteristics(&#123;</span><br><span class=\"line\">        deviceId: deviceId.value,</span><br><span class=\"line\">        serviceId: serviceId.value,</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(res) // 可以在此判断特征值是否支持读写等操作，特征值其实也需要提前向硬件佬索取的</span><br><span class=\"line\">            uni.showToast(&#123;</span><br><span class=\"line\">                title: &#x27;获取特征值成功&#x27;</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">            uni.showToast(&#123;</span><br><span class=\"line\">                title: &#x27;获取特征值失败&#x27;,</span><br><span class=\"line\">                icon: &#x27;error&#x27;</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">const characteristicId = ref(&#x27;0000FFE1-0000-1000-8000-00805F9B34FB&#x27;)</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【8】开启消息监听</span><br><span class=\"line\">function notify() &#123;</span><br><span class=\"line\">    uni.notifyBLECharacteristicValueChange(&#123;</span><br><span class=\"line\">        deviceId: deviceId.value, // 设备id</span><br><span class=\"line\">        serviceId: serviceId.value, // 监听指定的服务</span><br><span class=\"line\">        characteristicId: characteristicId.value, // 监听对应的特征值</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(res)</span><br><span class=\"line\">            listenValueChange()</span><br><span class=\"line\">            uni.showToast(&#123;</span><br><span class=\"line\">                title: &#x27;已开启监听&#x27;</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">            uni.showToast(&#123;</span><br><span class=\"line\">                title: &#x27;监听失败&#x27;,</span><br><span class=\"line\">                icon: &#x27;error&#x27;</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// ArrayBuffer转16进度字符串示例</span><br><span class=\"line\">function ab2hex(buffer) &#123;</span><br><span class=\"line\">  const hexArr = Array.prototype.map.call(</span><br><span class=\"line\">    new Uint8Array(buffer),</span><br><span class=\"line\">    function (bit) &#123;</span><br><span class=\"line\">      return (&#x27;00&#x27; + bit.toString(16)).slice(-2)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  )</span><br><span class=\"line\">  return hexArr.join(&#x27;&#x27;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 将16进制的内容转成我们看得懂的字符串内容</span><br><span class=\"line\">function hexCharCodeToStr(hexCharCodeStr) &#123;</span><br><span class=\"line\">    var trimedStr = hexCharCodeStr.trim();</span><br><span class=\"line\">    var rawStr = trimedStr.substr(0, 2).toLowerCase() === &quot;0x&quot; ? trimedStr.substr(2) : trimedStr;</span><br><span class=\"line\">    var len = rawStr.length;</span><br><span class=\"line\">    if (len % 2 !== 0) &#123;</span><br><span class=\"line\">            alert(&quot;存在非法字符!&quot;);</span><br><span class=\"line\">            return &quot;&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    var curCharCode;</span><br><span class=\"line\">    var resultStr = [];</span><br><span class=\"line\">    for (var i = 0; i &lt; len; i = i + 2) &#123;</span><br><span class=\"line\">            curCharCode = parseInt(rawStr.substr(i, 2), 16);</span><br><span class=\"line\">            resultStr.push(String.fromCharCode(curCharCode));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return resultStr.join(&quot;&quot;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 监听到的内容</span><br><span class=\"line\">const message = ref(&#x27;&#x27;)</span><br><span class=\"line\">const messageHex = ref(&#x27;&#x27;) // 十六进制</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【9】监听消息变化</span><br><span class=\"line\">function listenValueChange() &#123;</span><br><span class=\"line\">    uni.onBLECharacteristicValueChange(res =&gt; &#123;</span><br><span class=\"line\">        console.log(res)</span><br><span class=\"line\">        let resHex = ab2hex(res.value)</span><br><span class=\"line\">        console.log(resHex)</span><br><span class=\"line\">        messageHex.value = resHex</span><br><span class=\"line\">        let result = hexCharCodeToStr(resHex)</span><br><span class=\"line\">        console.log(String(result))</span><br><span class=\"line\">        message.value = String(result)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【10】发送数据</span><br><span class=\"line\">function send() &#123;</span><br><span class=\"line\">    // 向蓝牙设备发送一个0x00的16进制数据</span><br><span class=\"line\">    let msg = &#x27;hello&#x27;</span><br><span class=\"line\">    </span><br><span class=\"line\">    const buffer = new ArrayBuffer(msg.length)</span><br><span class=\"line\">    const dataView = new DataView(buffer)</span><br><span class=\"line\">    // dataView.setUint8(0, 0)</span><br><span class=\"line\">    </span><br><span class=\"line\">    for (var i = 0; i &lt; msg.length; i++) &#123;</span><br><span class=\"line\">      dataView.setUint8(i, msg.charAt(i).charCodeAt())</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    uni.writeBLECharacteristicValue(&#123;</span><br><span class=\"line\">      deviceId: deviceId.value,</span><br><span class=\"line\">      serviceId: serviceId.value,</span><br><span class=\"line\">      characteristicId: characteristicId.value,</span><br><span class=\"line\">      value: buffer,</span><br><span class=\"line\">      success(res) &#123;</span><br><span class=\"line\">        console.log(&#x27;writeBLECharacteristicValue success&#x27;, res.errMsg)</span><br><span class=\"line\">            uni.showToast(&#123;</span><br><span class=\"line\">                title: &#x27;write指令发送成功&#x27;</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">            uni.showToast(&#123;</span><br><span class=\"line\">                title: &#x27;write指令发送失败&#x27;,</span><br><span class=\"line\">                icon: &#x27;error&#x27;</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">// 【11】读取数据</span><br><span class=\"line\">function read() &#123;</span><br><span class=\"line\">    uni.readBLECharacteristicValue(&#123;</span><br><span class=\"line\">        deviceId: deviceId.value,</span><br><span class=\"line\">        serviceId: serviceId.value,</span><br><span class=\"line\">        characteristicId: characteristicId.value,</span><br><span class=\"line\">        success(res) &#123;</span><br><span class=\"line\">            console.log(res)</span><br><span class=\"line\">            uni.showToast(&#123;</span><br><span class=\"line\">                title: &#x27;read指令发送成功&#x27;</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        fail(err) &#123;</span><br><span class=\"line\">            console.error(err)</span><br><span class=\"line\">            uni.showToast(&#123;</span><br><span class=\"line\">                title: &#x27;read指令发送失败&#x27;,</span><br><span class=\"line\">                icon: &#x27;error&#x27;</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">​</span><br><span class=\"line\">&lt;style&gt;</span><br><span class=\"line\">.box &#123;</span><br><span class=\"line\">    width: 98%;</span><br><span class=\"line\">    height: 400rpx;</span><br><span class=\"line\">    box-sizing: border-box;</span><br><span class=\"line\">    margin: 0 auto 20rpx;</span><br><span class=\"line\">    border: 2px solid dodgerblue;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">.item &#123;</span><br><span class=\"line\">    box-sizing: border-box;</span><br><span class=\"line\">    padding: 10rpx;</span><br><span class=\"line\">    border-bottom: 1px solid #ccc;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">button &#123;</span><br><span class=\"line\">    margin-bottom: 20rpx;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">.msg_x &#123;</span><br><span class=\"line\">    border: 2px solid seagreen;</span><br><span class=\"line\">    width: 98%;</span><br><span class=\"line\">    margin: 10rpx auto;</span><br><span class=\"line\">    box-sizing: border-box;</span><br><span class=\"line\">    padding: 20rpx;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">​</span><br><span class=\"line\">.msg_x .msg_txt &#123;</span><br><span class=\"line\">    margin-bottom: 20rpx;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/style&gt;</span><br></pre></td></tr></table></figure></p>\n<p>作者：德育处主任<br>链接：<a href=\"https://juejin.cn/post/7093171532318375950\">https://juejin.cn/post/7093171532318375950</a><br>来源：稀土掘金<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>\n",
            "tags": [
                "蓝牙",
                "小程序蓝牙",
                "蓝牙连接"
            ]
        }
    ]
}