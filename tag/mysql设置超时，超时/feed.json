{
    "version": "https://jsonfeed.org/version/1",
    "title": "艾瑞可erik • All posts by \"mysql设置超时，超时\" tag • All posts by \"undefined\" categories",
    "description": "一只PHP开发的程序猿，偶尔做做运维、Goland、Python、Java、摄影、画画、写作、顺便睡觉，反正整站都搞过。",
    "home_page_url": "https://erik.xyz",
    "items": [
        {
            "id": "https://erik.xyz/2014/12/22/wei-mysql-she-zhi-cha-xun-chao-shi/",
            "url": "https://erik.xyz/2014/12/22/wei-mysql-she-zhi-cha-xun-chao-shi/",
            "title": "为MySQL设置查询超时",
            "date_published": "2014-12-22T13:03:00.000Z",
            "content_html": "<p>作者: <a href=\"http://www.laruence.com\">Laruence</a> 昨天有人在群里问, MySQL是否可以设置读写超时(非连接超时), 如果可以就可以避免一条SQL执行过慢, 导致PHP超时错误. 这个, 其实可以有. 只不过稍微要麻烦点. 首先, 在libmysql中, 是提供了MYSQL_OPT_READ_TIMEOUT设置项的, 并且libmysql中提供了设置相关设置项的API, mysql_options:<span id=\"more\"></span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int STDCALL</span><br><span class=\"line\">  mysql_options(MYSQL *mysql,enum mysql_option option, const void *arg)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    DBUG_ENTER(&quot;mysql_option&quot;);</span><br><span class=\"line\">    DBUG_PRINT(&quot;enter&quot;,(&quot;option: %d&quot;,(int) option));</span><br><span class=\"line\">    switch (option) &#123;</span><br><span class=\"line\">    case MYSQL\\_OPT\\_CONNECT_TIMEOUT:</span><br><span class=\"line\">      mysql-&gt;options.connect_timeout= *(uint*) arg;</span><br><span class=\"line\">      break;</span><br><span class=\"line\">    /\\*\\* 读超时时间 */</span><br><span class=\"line\">   case MYSQL\\_OPT\\_READ_TIMEOUT:</span><br><span class=\"line\">      mysql-&gt;options.read_timeout= *(uint*) arg;</span><br><span class=\"line\">      break;</span><br><span class=\"line\">    case MYSQL\\_OPT\\_WRITE_TIMEOUT:</span><br><span class=\"line\">      mysql-&gt;options.write_timeout= *(uint*) arg;</span><br><span class=\"line\">      break;</span><br><span class=\"line\">    case MYSQL\\_OPT\\_COMPRESS:</span><br><span class=\"line\">      mysql-&gt;options.compress= 1;</span><br><span class=\"line\"></span><br><span class=\"line\">     /\\* 以下省略 */</span><br></pre></td></tr></table></figure>\n<p>但是, 可惜的是, 目前只有mysqli扩展, 把mysql_options完全暴露给了PHP:<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PHP_FUNCTION(mysqli_options)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> /\\*\\* 有省略 */</span><br><span class=\"line\">     switch (Z\\_TYPE\\_PP(mysql_value)) &#123;</span><br><span class=\"line\">        /\\*\\* 没有任何限制, 直接传递给mysql_options */</span><br><span class=\"line\">        case IS_STRING:</span><br><span class=\"line\">            ret = mysql_options(mysql-&gt;mysql, mysql_option, Z\\_STRVAL\\_PP(mysql_value));</span><br><span class=\"line\">            break;</span><br><span class=\"line\">         default:</span><br><span class=\"line\">            convert\\_to\\_long_ex(mysql_value);</span><br><span class=\"line\">             l_value = Z\\_LVAL\\_PP(mysql_value);</span><br><span class=\"line\">            ret = mysql_options(mysql-&gt;mysql, mysql_option, (char *)&amp;l_value);</span><br><span class=\"line\">            break;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    RETURN_BOOL(!ret);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><br>但是因为Mysqli并没有导出这个常量, 所以我们需要通过查看MySQL的代码, 得到MYSQL_OPT_READ_TIMEOUT的实际值, 然后直接调用mysql_options:<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">enum mysql_option</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  MYSQL\\_OPT\\_CONNECT_TIMEOUT, MYSQL\\_OPT\\_COMPRESS, MYSQL\\_OPT\\_NAMED_PIPE,</span><br><span class=\"line\">  MYSQL\\_INIT\\_COMMAND, MYSQL\\_READ\\_DEFAULT_FILE, MYSQL\\_READ\\_DEFAULT_GROUP,</span><br><span class=\"line\">  MYSQL\\_SET\\_CHARSET_DIR, MYSQL\\_SET\\_CHARSET_NAME, MYSQL\\_OPT\\_LOCAL_INFILE,</span><br><span class=\"line\">   MYSQL\\_OPT\\_PROTOCOL, MYSQL\\_SHARED\\_MEMORY\\_BASE\\_NAME, MYSQL\\_OPT\\_READ_TIMEOUT,</span><br><span class=\"line\">  MYSQL\\_OPT\\_WRITE_TIMEOUT, MYSQL\\_OPT\\_USE_RESULT,</span><br><span class=\"line\">  MYSQL\\_OPT\\_USE\\_REMOTE\\_CONNECTION, MYSQL\\_OPT\\_USE\\_EMBEDDED\\_CONNECTION,</span><br><span class=\"line\">  MYSQL\\_OPT\\_GUESS_CONNECTION, MYSQL\\_SET\\_CLIENT_IP, MYSQL\\_SECURE\\_AUTH,</span><br><span class=\"line\">  MYSQL\\_REPORT\\_DATA_TRUNCATION, MYSQL\\_OPT\\_RECONNECT,</span><br><span class=\"line\">  MYSQL\\_OPT\\_SSL\\_VERIFY\\_SERVER_CERT</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure><br>可以看到, MYSQL_OPT_READ_TIMEOUT为11. 现在, 我们就可以设置查询超时了:<br><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$mysqli = mysqli_init();</span><br><span class=\"line\">$mysqli-&gt;options(11 /\\*MYSQL\\_OPT\\_READ_TIMEOUT\\*/, 1);</span><br><span class=\"line\">$mysql-&gt;real_connect(***);</span><br></pre></td></tr></table></figure><br>不过, 因为在libmysql中有重试机制(尝试一次, 重试俩次), 所以, 最终我们设置的超时阈值都会三倍于我们设置的值. 也就是说, 如果我们设置了MYSQL_OPT_READ_TIMEOUT为1, 最终会在3s以后超时结束. 也就是说, 我们目前能设置的最短超时时, 就是3秒… 虽说大了点,, 不过总比没有好, 呵呵 PS: 写了一半的时候, 就发现小黑已经写过一篇了, 所以大家也可以参看这篇<a href=\"http://blog.csdn.net/heiyeshuwu/archive/2010/09/08/5869813.aspx\">PHP访问MySQL查询超时处理</a></p>\n",
            "tags": [
                "php服务器",
                "centos6.5",
                "mysql",
                "mysql设置超时，超时"
            ]
        }
    ]
}