{
    "version": "https://jsonfeed.org/version/1",
    "title": "艾瑞可erik • All posts by \"http服务器\" tag • All posts by \"undefined\" categories",
    "description": "一只PHP开发的程序猿，偶尔做做运维、Goland、Python、Java、摄影、画画、写作、顺便睡觉，反正整站都搞过。",
    "home_page_url": "https://erik.xyz",
    "items": [
        {
            "id": "https://erik.xyz/2015/02/05/windows-shang-jing-tai-bian-yi-libevent-2-0-10-bing-shi-xian-yi-ge-jian-dan-http-fu-wu-qi/",
            "url": "https://erik.xyz/2015/02/05/windows-shang-jing-tai-bian-yi-libevent-2-0-10-bing-shi-xian-yi-ge-jian-dan-http-fu-wu-qi/",
            "title": "Windows 上静态编译 Libevent 2.0.10 并实现一个简单 HTTP 服务器",
            "date_published": "2015-02-05T15:51:00.000Z",
            "content_html": "<p>[文章作者：张宴 ] 本文介绍了如何在 Windows 操作系统中，利用微软 Visual Studio 2005 编译生成 <a href=\"http://monkey.org/%7Eprovos/libevent/\">Libevent</a> 2.0.10 静态链接库，并利用 <a href=\"http://monkey.org/%7Eprovos/libevent/\">Libevent</a> 静态链接库，实现一个简单的 HTTP Web服务器程序：httpd.exe。 假设 Visual Studio 2005 的安装路径为“D:\\Program Files\\Microsoft Visual Studio 8\\”，<a href=\"http://monkey.org/%7Eprovos/libevent/\">Libevent</a> 2.0.10 解压后的路径为“D:\\libevent-2.0.10-stable”。<br><span id=\"more\"></span></p>\n<hr>\n<p><strong>一、编译生成 Libevent 2.0.10 静态链接库。</strong> </p>\n<ol>\n<li><p>修改“D:\\libevent-2.0.10-stable\\event_iocp.c”、“D:\\libevent-2.0.10-stable \\evthread_win32.c”、“D:\\libevent-2.0.10-stable\\listener.c”三个文件，在文件开头分别加上一 行：</p>\n<h1 id=\"define-WIN32-WINNT-0x0500\"><a href=\"#define-WIN32-WINNT-0x0500\" class=\"headerlink\" title=\"define _WIN32_WINNT 0x0500\"></a>define _WIN32_WINNT 0x0500</h1></li>\n<li><p>鼠标点击Windows左下角的【开始】-【所有程序】，找到【Microsoft Visual Studio 2005】，执行下图中的脚本： </p>\n<p><a href=\"http://zyan.cc/attachment/201103/libevent/libevent1.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent1.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a> </p>\n</li>\n<li><p>按照下图中的方法编译Libevent 2.0.10：<br><a href=\"http://zyan.cc/attachment/201103/libevent/libevent2.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent2.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a> </p>\n</li>\n<li><p>生成的“libevent.lib”、“libevent_core.lib”、“libevent_extras.lib”三个文件就是我们需要的 Libevent 静态链接库。<br><a href=\"http://zyan.cc/attachment/201103/libevent/libevent3.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent3.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a></p>\n</li>\n</ol>\n<hr>\n<p><strong>二、利用 Libevent 静态链接库，实现一个简单的 HTTP Web服务器程序</strong> </p>\n<ol>\n<li><p>打开 Visual Studio 2005，新建一个项目<br><a href=\"http://zyan.cc/attachment/201103/libevent/libevent4.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent4.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a></p>\n</li>\n<li><p>选择在“d:\\test”目录内创建一个“Win32 控制台应用程序”<br><a href=\"http://zyan.cc/attachment/201103/libevent/libevent5.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent5.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a> </p>\n</li>\n<li><p>按照下图进行选择<br><a href=\"http://zyan.cc/attachment/201103/libevent/libevent6.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent6.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a> </p>\n</li>\n<li><p>创建完成项目后，会自动生成“d:\\test\\httpd\\”目录，在该目录内创建一个“httpd.c”文件，内容如下：<br> <a href=\"http://zyan.cc/#\">view plain</a><a href=\"http://zyan.cc/#\">print</a><a href=\"http://zyan.cc/#\">?</a></p>\n</li>\n</ol>\n<pre><code>  #include &lt;stdio.h&gt;\n\n      #define WIN32\\_LEAN\\_AND_MEAN\n     #include &lt;windows.h&gt;\n      #include &lt;winsock2.h&gt;\n\n      #include &lt;event.h&gt;\n      #include &lt;evhttp.h&gt;\n\n      void root_handler(struct evhttp_request *req, void *arg)\n      &#123;\n          struct evbuffer *buf = evbuffer_new();\n          if(!buf)&#123;\n              puts(&quot;failed to create response buffer&quot;);\n              return;\n          &#125;\n\n          evbuffer\\_add\\_printf(buf, &quot;Hello: %s\\\\n&quot;, evhttp\\_request\\_uri(req));\n          evhttp\\_send\\_reply(req, HTTP_OK, &quot;OK&quot;, buf);\n      &#125;\n\n      void generic_handler(struct evhttp_request *req, void *arg)\n      &#123;\n          struct evbuffer *buf = evbuffer_new();\n          if(!buf)&#123;\n              puts(&quot;failed to create response buffer&quot;);\n              return;\n          &#125;\n\n          evbuffer\\_add\\_printf(buf, &quot;Requested: %s\\\\n&quot;, evhttp\\_request\\_uri(req));\n          evhttp\\_send\\_reply(req, HTTP_OK, &quot;OK&quot;, buf);\n      &#125;\n\n      int main(int argc, wchar_t* argv\\[\\])\n      &#123;\n        struct evhttp *httpd;\n\n        WSADATA wsaData;\n        DWORD Ret;\n        if ((Ret = WSAStartup(MAKEWORD(2, 2), &amp;wsaData)) != 0)  &#123;\n          printf(&quot;WSAStartup failed with error %d\\\\n&quot;, Ret);\n          return -1;\n        &#125;\n\n          event_init();\n\n          httpd = evhttp_start(&quot;0.0.0.0&quot;, 8505);\n          if(!httpd)&#123;\n          return 1;\n        &#125;\n\n          evhttp\\_set\\_cb(httpd, &quot;/&quot;, root_handler, NULL);\n          evhttp\\_set\\_gencb(httpd, generic_handler, NULL);\n\n        printf(&quot;httpd server start OK!\\\\n&quot;);\n\n          event_dispatch();\n\n          evhttp_free(httpd);\n\n        WSACleanup();\n          return 0;\n   &#125;\n</code></pre><p>5、回到 Visual Studio 2005，在左侧的【源文件】中选择【添加】-【现有项】，将上一步创建的“httpd.c”文件添加进来。</p>\n<p> <a href=\"http://zyan.cc/attachment/201103/libevent/libevent7.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent7.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a> </p>\n<p>6、在【解决方案“httpd”】上点击鼠标右键，选择【属性】 </p>\n<p><a href=\"http://zyan.cc/attachment/201103/libevent/libevent8.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent8.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a> </p>\n<p>7、将【配置】改为“Release”</p>\n<p><a href=\"http://zyan.cc/attachment/201103/libevent/libevent9.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent9.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a> </p>\n<p>8、将“D:\\libevent-2.0.10-stable\\include”整个目录复制到“D:\\test\\httpd\\include”；将 “D:\\libevent-2.0.10-stable\\WIN32-Code”目录内的“tree.h”文件和“event2”子目录，复制到“D: \\test\\httpd\\include\\”内；将“D:\\libevent-2.0.10-stable\\”目录内的所有“*.h”头文件复制到“D: \\test\\httpd\\include\\”内。可以在Windows左下角的【开始】-【运行】中输入“cmd”回车，在命令行窗口中执行以下命令，完 成复制过程。</p>\n<p>mkdir D:\\test\\httpd\\include\\ xcopy /E /H /R D:\\libevent-2.0.10-stable\\include\\<em> D:\\test\\httpd\\include\\ xcopy /E /H /R D:\\libevent-2.0.10-stable\\WIN32-Code\\</em> D:\\test\\httpd\\include\\ xcopy /E /H /R D:\\libevent-2.0.10-stable\\*.h D:\\test\\httpd\\include\\</p>\n<p><a href=\"http://zyan.cc/attachment/201103/libevent/libevent10.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent10.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a></p>\n<p><a href=\"http://zyan.cc/attachment/201103/libevent/libevent11.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent11.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a> </p>\n<p>9、回到 Visual Studio 2005，在左侧菜单中【解决方案“httpd”】下面一行【httpd】上点击鼠标邮件，选择【属性】，对每项内容进行修改。下图中红框内的数据即为修改后的数据。 </p>\n<p><a href=\"http://zyan.cc/attachment/201103/libevent/libevent12.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent12.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a> </p>\n<p><a href=\"http://zyan.cc/attachment/201103/libevent/libevent13.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent13.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a> </p>\n<p><a href=\"http://zyan.cc/attachment/201103/libevent/libevent14.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent14.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a> </p>\n<p><a href=\"http://zyan.cc/attachment/201103/libevent/libevent15.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent15.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a></p>\n<p>注：下图中，附加依赖项填写：</p>\n<pre><code>    ws2\\_32.lib wsock32.lib libevent.lib libevent\\_core.lib libevent_extras.lib\n</code></pre><p>忽略特定库填写：</p>\n<p>libc.lib;msvcrt.lib;libcd.lib;libcmtd.lib;msvcrtd.lib</p>\n<p><a href=\"http://zyan.cc/attachment/201103/libevent/libevent16.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent16.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a></p>\n<p>10、完成设置后，在【解决方案“httpd”】上点击鼠标右键，选择【生成解决方案】。如果是重新编译，可以选择【重新生成解决方案】。生成成功后，“d:\\test\\httpd\\Release”目录内的“httpd.exe”即为生成的可执行文件。 </p>\n<p><a href=\"http://zyan.cc/attachment/201103/libevent/libevent17.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent17.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a> </p>\n<p>11、双击“httpd.exe”运行后，打开浏览器，访问“<a href=\"http://127.0.0.1:8505/\">http://127.0.0.1:8505/</a>”，则可以看到以下信息：一个简单的 HTTP Web Server 输出的内容。</p>\n<p><a href=\"http://zyan.cc/attachment/201103/libevent/libevent18.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent18.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a> </p>\n<p>12、如果你觉得像DOS程序一样的“httpd.exe”可执行文件图标不好看、没有显示版本信息，那么，你可以按照下图步骤，添加ICO图标文件。 </p>\n<p><a href=\"http://zyan.cc/attachment/201103/libevent/libevent19.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent19.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a> </p>\n<p><a href=\"http://zyan.cc/attachment/201103/libevent/libevent20.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent20.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a> </p>\n<p>13、添加版本信息 </p>\n<p><a href=\"http://zyan.cc/attachment/201103/libevent/libevent21.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent21.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a> </p>\n<p><a href=\"http://zyan.cc/attachment/201103/libevent/libevent22.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent22.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a> </p>\n<p>14、大功告成，下面显示的是带有自定义图标、版本信息的“httpd.exe”可执行程序。 <a href=\"http://zyan.cc/attachment/201103/libevent/libevent23.png\"><img src=\"http://zyan.cc/attachment/201103/libevent/libevent23.png\" alt=\"点击在新窗口中浏览此图片\" title=\"点击在新窗口中浏览此图片\"></a></p>\n<hr>\n<p><strong>附1：编译好的 Libevent 2.0.10 静态链接库与 httpd 的 Visual Studio 2005 工程源代码下载</strong></p>\n<p><img src=\"http://zyan.cc/template/RuiPai/images/download.gif\" alt=\"\">下载文件</p>\n<p><a href=\"http://blog.zyan.cc/attachment/201103/libevent/httpd.zip\">点击这里下载文件</a></p>\n<p><strong>附2：ICO图标制作工具下载</strong></p>\n<p><img src=\"http://zyan.cc/template/RuiPai/images/download.gif\" alt=\"\">下载文件</p>\n<p><a href=\"http://blog.zyan.cc/attachment/201103/libevent/iconxp.zip\">点击这里下载文件</a></p>\n<p>转载请注明原文链接：<a href=\"http://blog.zyan.cc/libevent_windows/\">http://blog.zyan.cc/libevent_windows/</a></p>\n",
            "tags": [
                "php服务器",
                "http",
                "http服务器"
            ]
        }
    ]
}